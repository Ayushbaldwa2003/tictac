<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tic-Tac-Toe Multiplayer</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="data:," />
  </head>
  <body>
    <div id="gameContainer">
        <!-- Header Message -->
        <h2 id="statusMessage">Welcome to Tic-Tac-Toe</h2>
  
        <!-- Create/Join Game Section -->
        <div id="setupContainer">
          <button id="createGameBtn">Create Game</button>
          <input type="text" id="txtGameId" placeholder="Enter Game code" />
          <button id="joinGameBtn">Join Game</button>
          <h3 id="gameCodeDisplay" style="display: none">
            Game Code: <span id="gameCode"></span>
          </h3>
        </div>
  
        <!-- Turn Indicator (Above Game Board) -->
        <h3 id="turnIndicator" style="display: none">It's your turn!</h3>
  
        <!-- Tic-Tac-Toe Board -->
        <div id="gameBoard" style="display: none">
          <div class="box" id="box1"></div>
          <div class="box" id="box2"></div>
          <div class="box" id="box3"></div>
          <div class="box" id="box4"></div>
          <div class="box" id="box5"></div>
          <div class="box" id="box6"></div>
          <div class="box" id="box7"></div>
          <div class="box" id="box8"></div>
          <div class="box" id="box9"></div>
        </div>
  
        <!-- Winner Display (Below Game Board) -->
        <h3 id="winnercodedisplay" style="display: none">
          <span id="winner"></span>
        </h3>
  
        <!-- New Game Button -->
        <button id="newGameBtn" style="display: none">New Game</button>
      </div>

    <script>
      const wsUrl =
        window.location.hostname === "localhost"
          ? "ws://localhost:3000"
          : "wss://tictac-7mgq.onrender.com";
      const ws = new WebSocket(wsUrl);

      const turnIndicator = document.getElementById("turnIndicator");
      const createbtn = document.getElementById("createGameBtn");
      const joinbtn = document.getElementById("joinGameBtn");
      const newGameBtn = document.getElementById("newGameBtn");
      const txtGameId = document.getElementById("txtGameId");
      let clienId = null;
      let gameId = null;
      let count=0;
      document
        .getElementById("newGameBtn")
        .addEventListener("click", resetGame);
      createbtn.addEventListener("click", () => {
        const payLoad = {
          method: "create",
          clientId: clientId,
        };

        ws.send(JSON.stringify(payLoad));
      });
      joinbtn.addEventListener("click", () => {
        let gamecode = txtGameId.value;
        if (!gamecode) {
          alert("Enter the game code first!");
        } else {
          gameId = gamecode;
          const payLoad = {
            method: "join",
            clientId: clientId,
            gameId: gamecode,
          };
          ws.send(JSON.stringify(payLoad));
        }
      });

      for (let i = 1; i <= 9; i++) {
        const box = document.getElementById("box" + i);
        box.addEventListener("click", () => {
          if (box.innerText === "") {
            const payLoad = {
              method: "play",
              clientId: clientId,
              gameId: gameId,
              box: box.id,
            };
            ws.send(JSON.stringify(payLoad));
          }
        });
      }

      ws.onmessage = (message) => {
        const response = JSON.parse(message.data);
        if (response.method === "connect") {
          clientId = response.clientId;
          console.log("Client id Set successfully " + clientId);
        }
        if (response.method === "create") {
          gameId = response.game.id;
          document.getElementById("gameCode").innerText = gameId;
          document.getElementById("gameCodeDisplay").style.display = "block";
        }

        if (response.method === "join") {
          document.getElementById("setupContainer").style.display = "none";
          document.getElementById("gameBoard").style.display = "grid";
        }

        if (response.method === "yourturn") {
            toggleTurnIndicator();
        }

        if (response.method === "update") {
          const boxx = response.box;
          const box = document.getElementById(boxx);
          const temp = response.symbol;
          box.textContent = temp;
          count++;
          if (checkwinner()) {
            showwinner(temp);
          }else{
              if(count===9){
                showdraw();
              }
          }
        }
      };

      function toggleTurnIndicator() {
        if (
          turnIndicator.style.display === "none" ||
          turnIndicator.style.display === ""
        ) {
          turnIndicator.style.display = "block"; 
        } else {
          turnIndicator.style.display = "none"; 
        }
      }

      function resetGame() {
        for (let i = 1; i <= 9; i++) {
          document.getElementById("box" + i).textContent = "";
        }
        document.getElementById("winner").innerText = "";
        count=0;
      }

      function showwinner(temp) {
        document.getElementById("winner").innerText = `winner is ${temp}`;
        document.getElementById("winnercodedisplay").style.display = "block";
        document.getElementById("newGameBtn").style.display = "block";
      }
      function showdraw(temp) {
        document.getElementById("winner").innerText = `It's draw`;
        document.getElementById("winnercodedisplay").style.display = "block";
        document.getElementById("newGameBtn").style.display = "block";
      }

      function checkwinner() {
        const winningCombinations = [
          ["box1", "box2", "box3"],
          ["box4", "box5", "box6"],
          ["box7", "box8", "box9"],
          ["box1", "box4", "box7"],
          ["box2", "box5", "box8"],
          ["box3", "box6", "box9"],
          ["box1", "box5", "box9"],
          ["box3", "box5", "box7"],
        ];

        for (const combination of winningCombinations) {
          const [a, b, c] = combination;
          const boxA = document.getElementById(a).textContent;
          const boxB = document.getElementById(b).textContent;
          const boxC = document.getElementById(c).textContent;
          if (boxA && boxA === boxB && boxA === boxC) {
            return true;
          }
        }

        return false;
      }
    </script>
  </body>
</html>
